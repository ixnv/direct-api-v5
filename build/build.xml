<?xml version="1.0" encoding="UTF-8"?>
<project name="eLama Identity &amp; Access" default="main">
    <property name="project.dir" value="${phing.dir}/../"/>
    <property name="project.lib-dir" value="${project.dir}/lib/"/>
    <property name="project.www-user" value="www-data"/>
    <property name="project.php_executable" value="php"/>

    <target name="init">
        <property name="hhvm_return_value" value="1"/>
        <exec executable="hhvm" outputProperty="hhvm_return_value">
            <arg value="--version"/>
        </exec>
        <if>
            <contains string="${hhvm_return_value}" substring="HipHop" casesensitive="true"/>
            <then>
                <property name="project.php_executable" value="hhvm" override="true"/>
            </then>
        </if>

        <echo message="Using ${project.php_executable} as php interpreter"/>
    </target>

    <target name="composer-update">
        <echo>composer - version:</echo>
        <exec executable="${project.php_executable}" dir="${project.dir}" passthru="true">
            <arg value="bin/composer.phar"/>
            <arg value="--version"/>
        </exec>
        <exec executable="${project.php_executable}" dir="${project.dir}" passthru="true">
            <arg value="bin/composer.phar"/>
            <arg value="update"/>
            <arg value="--profile"/>
        </exec>
    </target>

    <target name="test-pull-request" depends="init">
        <phingcall target="composer-update"/>
        <phingcall target="run-tests"/>
    </target>

    <target name="run-tests">
        <exec executable="php" dir="${project.dir}" passthru="true"  checkreturn="true">
            <arg line="
            -d zend_extension=/usr/lib/php5/20121212/xdebug.so
            -d xdebug.coverage_enable=1
            bin/phpunit -c tests/phpunit.xml
            --log-junit build/phpunit/phpunit.xml
            --coverage-clover build/phpunit/coverage/clover.xml
            --coverage-html build/phpunit/coverage/html" />
        </exec>
    </target>

    <target name="code-style" depends="init, composer-update, php-code-sniffer">
    </target>

    <target name="php-code-sniffer">
        <exec executable="build/phpcs.sh" dir="${project.dir}" passthru="true" checkreturn="true"/>
    </target>

    <target name="main" depends="init, composer-update, run-tests"/>

</project>

